---
title: '第三部分：安全加固与审计'
description: '深入探讨 Linux 用户账户的安全加固和活动审计策略'
date: 2025-07-15
tags: ['Linux', '用户管理', '组管理']
order: 3
authors: ['rocky']
draft: false
---

用户账户的安全加固和活动审计是 Linux 系统安全管理不可或缺的环节。它们共同构成了系统防御体系的「最后一道防线」，旨在预防未经授权的访问，并在安全事件发生时提供追溯能力。

## 1. 用户账户安全策略

有效的用户账户安全策略能够从根本上降低系统面临的风险。

### 密码策略：复杂度、有效期 (`chage` 命令详解)

密码是用户身份认证的第一道防线，其强度和生命周期管理至关重要。Linux 系统通过 `chage` 命令来管理用户密码的过期信息和账户有效期。  

**`chage` 命令详解**： `chage` 命令用于更改用户密码的有效期信息，这些信息存储在 `/etc/shadow` 文件中。  

- **语法**：`chage LOGIN`

- **常用参数**：

  - **`-l, --list`**：列出指定用户的密码老化信息。这是查看当前策略最常用的选项。  

    ```
    sudo chage -l john
    # 输出示例：
    # Last password change                                : Jul 15, 2024
    # Password expires                                  : Aug 13, 2024
    # Password inactive                                 : never
    # Account expires                                   : never
    # Minimum number of days between password change    : 7
    # Maximum number of days between password change    : 30
    # Number of days of warning before password expires : 7
    ```

  - **`-d, --lastday LAST_DAY`**：设置上次密码修改的日期。日期可以指定为 `YYYY-MM-DD` 格式，或自 1970 年 1 月 1 日以来的天数。如果设置为 `0`，则表示用户在下次登录时必须更改密码。  

    ```
    sudo chage -d 2024-01-01 jane # 设置 jane 的上次密码修改日期为 2024 年 1 月 1 日
    sudo chage -d 0 bob # 强制 bob 在下次登录时更改密码
    ```

  - **`-m, --mindays MIN_DAYS`**：设置两次密码修改之间的最小天数。在此天数内，用户不允许更改密码。`0` 表示无限制。  

    ```
    sudo chage -m 7 john # john 在 7 天内不能再次更改密码
    ```

  - **`-M, --maxdays MAX_DAYS`**：设置密码必须更改前的最大有效天数。如果设置为 `-1`，则表示密码永不失效。  

    ```
    sudo chage -M 90 john # john 的密码每 90 天必须更改一次
    sudo chage -M -1 admin # admin 的密码永不强制过期 (不推荐高权限账户)
    ```

  - **`-W, --warndays WARN_DAYS`**：设置密码过期前，系统开始警告用户的天数。  

    ```
    sudo chage -W 14 john # john 在密码过期前 14 天开始收到警告
    ```

  - **`-I, --inactive INACTIVE`**：设置密码过期后，账户在被禁用前的天数。在此不活跃期内，用户仍可登录，但应更改密码。此期限过后，账户将被锁定。  

    ```
    sudo chage -I 30 tempuser # 密码过期后 30 天不登录，账户将被锁定
    ```

  - **`-E, --expiredate EXPIRE_DATE`**：设置账户的绝对过期日期。日期格式为 `YYYY-MM-DD`。账户到期后将被禁用，用户无法登录。如果设置为 `-1`，则表示账户永不失效；如果设置为 `0`，则表示账户立即失效。  

    ```
    sudo chage -E 2025-12-31 tempuser # tempuser 账户在 2025 年 12 月 31 日过期
    sudo chage -E 0 olduser # olduser 账户立即失效
    ```

**密码复杂度**：虽然 `chage` 命令主要管理密码的「生命周期」和「老化」策略，但密码的「复杂度」通常通过可插拔认证模块 (PAM) 来强制执行。例如，`pam_cracklib` 或 `pam_pwquality` 模块可以在 `/etc/pam.d/passwd` 或 `/etc/security/pwquality.conf` 等文件中配置，以强制要求密码包含特定长度、大小写字母、数字和特殊字符等。  

`chage` 命令对密码生命周期的精细化控制（最小/最大有效期、警告期、不活跃期）是 Linux 强制执行「主动安全策略」的关键工具。长期使用相同密码，或使用弱密码，是常见的安全漏洞来源。废弃的账户如果未被禁用，也可能成为攻击目标。`chage` 命令通过以下策略有效降低了这些风险：

- **最小有效期 (`-m`)**：防止用户频繁更改密码为旧密码，或在被强制更改后立即改回弱密码。
- **最大有效期 (`-M`)**：强制用户定期更改密码，降低密码泄露后的风险窗口。
- **警告期 (`-W`)**：提前通知用户，给予其充足时间更改密码，避免因密码过期而突然无法登录。
- **不活跃期 (`-I`)**：在密码过期后，给予用户一定的宽限期，如果仍未登录并更改密码，则自动禁用账户，防止长期未使用的账户成为僵尸账户。
- **账户过期日期 (`-E`)**：用于管理临时账户（如外包人员），确保其在合同结束后自动禁用，符合最小权限原则。这些策略共同构建了一个「动态密码安全」模型，将密码安全从静态的「复杂度」要求（通常由 PAM 模块处理）扩展到动态的「生命周期」管理。这使得系统能够主动地降低与密码相关的风险，是企业安全合规性（如 PCI DSS、ISO 27001）的重要组成部分。因此，管理员应根据组织的安全策略，合理配置用户账户的密码老化参数。例如，对于高权限账户，可以设置较短的最大有效期和较长的最小有效期。对于临时账户，务必设置账户过期日期。定期使用 `chage -l` 审计用户密码状态，并结合日志分析，是维护账户安全的重要实践。

### 账户锁定与禁用

当需要暂时或永久阻止用户登录系统时，有多种方法可以实现账户的锁定和禁用。

- **锁定密码 (`usermod -L` / `passwd -l`)**：

  - 此方法通过修改 `/etc/shadow` 文件中用户的加密密码字段，使其失效，从而阻止用户通过密码认证登录。  

  - `usermod -L username`：在 `/etc/shadow` 中该用户的密码字段前添加一个 `!` 字符。  

    ```
    sudo usermod -L john # 锁定 john 的密码
    ```

  - `passwd -l username`：效果类似，也会在密码字段前添加一个 `!` 字符。  

    ```
    sudo passwd -l jane # 锁定 jane 的密码
    ```

  - **缺点**：这种方法主要针对密码认证。需要注意的是，如果用户配置了其他认证方式（如 SSH 密钥认证），仅仅锁定密码可能无法阻止其登录。  

- **禁用账户 (`usermod -e EXPIRE_DATE` / `chage -E EXPIRE_DATE`)**：

  - 此方法通过将账户的过期日期设置为一个过去的时间，使账户立即失效。一旦账户过期，用户将无法通过任何方式（包括密码和 SSH 密钥）登录系统。  

  - `usermod -e YYYY-MM-DD username`：将账户过期日期设置为指定日期。设置为当前日期或之前的日期即可立即禁用。  

    ```
    sudo usermod -e 1970-01-02 john # 禁用 john 的账户（日期设置为过去）
    ```

    （注意：`1970-01-01` 在某些系统上可能被解释为永不失效，建议使用 `1970-01-02` 或更晚的过去日期。）  

  - `chage -E EXPIRE_DATE username`：功能与 `usermod -e` 类似。设置为 `0` 即可立即禁用账户。  

    ```
    sudo chage -E 0 jane # 禁用 jane 的账户
    ```

  - **优点**：这是禁用账户最彻底的方法，能够阻止所有形式的登录。

  - **解锁账户**：

    - `usermod -U username`：解锁密码。  

    - `usermod -e '' username` 或 `chage -E -1 username`：移除账户过期日期，重新启用账户。  

      ```
      sudo usermod -U john # 解锁 john 的密码
      sudo usermod -e '' john # 移除 john 的账户过期日期
      ```

通过区分密码锁定和账户禁用，系统管理员可以根据安全需求选择最合适的控制粒度。密码锁定是一种部分措施，可能无法完全阻止所有形式的登录（例如，如果用户配置了 SSH 密钥认证）。而账户禁用（通过设置过期日期）则提供了一种更彻底的账户关闭方式，能够阻止所有形式的登录。这种区别对于全面的安全管理至关重要，尤其是在处理临时账户或已确认被入侵的账户时。理解每种方法的完整影响，有助于管理员做出更明智的安全决策。

### 限制用户登录 (`/etc/nologin`, `nologin` shell)

除了锁定和禁用账户，还可以通过特定的机制来限制用户的登录能力。

- **`/etc/nologin` 文件**：

  - **工作原理**：当系统根目录下存在 `/etc/nologin` 文件时，所有非 `root` 用户都将被阻止登录系统。当用户尝试登录时，系统会显示 `/etc/nologin` 文件中的内容作为登录被拒绝的消息。  

  - **应用场景**：通常用于系统维护、升级或紧急情况，需要临时阻止所有普通用户登录时。

  - **用法**：

    ```
    sudo touch /etc/nologin # 创建文件以阻止登录
    echo "System is undergoing maintenance. Please try again later." | sudo tee /etc/nologin # 添加自定义消息
    ```

  - **解除限制**：只需删除 `/etc/nologin` 文件即可。

    ```
    sudo rm /etc/nologin
    ```

- **`nologin` shell (`/sbin/nologin` 或 `/bin/false`)**：

  - **工作原理**：通过将用户的登录 shell 设置为 `nologin` 或 `false`，可以阻止该用户获得交互式 shell 会话。当用户尝试登录时，  

    `nologin` 程序会打印一条消息并立即退出，而 `false` 命令则直接退出，不显示任何消息。  

  - **应用场景**：主要用于服务账户或那些不应拥有交互式登录权限的用户。例如，`www-data`、`mysql` 等系统服务账户的 shell 通常设置为 `nologin`，以防止它们被用于登录系统。  

  - **用法**：

    ```
    sudo usermod -s /sbin/nologin serviceuser # 将 serviceuser 的 shell 设置为 nologin
    ```

  - **自定义消息**：`nologin` shell 允许通过修改 `/etc/nologin.txt` 文件来定制用户被拒绝登录时显示的消息。  

    ```
    echo "Your account is for service access only. Interactive login is disabled." | sudo tee /etc/nologin.txt
    ```

通过比较 `/etc/nologin`（系统范围的临时锁定）和 `nologin` shell（针对每个用户的交互式会话永久锁定），系统管理员可以根据需求选择不同的登录限制粒度。`/etc/nologin` 文件提供了一种快速、临时地阻止所有普通用户登录系统的方法，非常适用于系统维护或紧急情况。而 `nologin` shell 则是针对特定用户（特别是服务账户）的更永久性限制，它确保这些账户无法用于交互式登录，从而降低了潜在的攻击面。这种区分对于全面的安全管理至关重要。`nologin` shell 对服务账户的限制，与最小权限原则高度一致，因为它将用户的能力限制在仅完成其必要任务的范围内，而不提供不必要的交互式访问。

## 2. 用户活动审计

用户活动审计是安全管理的关键环节，它通过记录和分析用户在系统上的行为，帮助管理员识别异常活动、追溯安全事件，并满足合规性要求。

### `last`, `lastb`, `who` 命令

这些命令提供了用户登录历史和当前会话的快速概览，是进行初步审计的常用工具。

- **`last` 命令**：

  - **作用**：显示系统上用户登录和注销的历史记录。它从 `/var/log/wtmp` 文件中读取数据。  

  - **输出内容**：通常包括用户名、登录终端 (TTY)、登录来源 (主机名/IP 地址)、登录时间、注销时间或「仍在登录」状态，以及会话持续时间。  

  - **用法**：

    ```
    last # 显示所有登录历史
    last -n 10 # 显示最近 10 条登录记录 [62]
    last -i # 显示 IP 地址而不是主机名 [62]
    last -x # 显示系统关机和运行级别更改记录 [62]
    last --since "2024-07-01" # 显示从指定日期以来的登录记录 [61]
    ```

  - **应用**：快速查看谁在何时登录了系统，以及会话持续时间，有助于初步的用户行为分析。

- **`lastb` 命令**：

  - **作用**：显示系统上失败的登录尝试历史记录。它从 `/var/log/btmp` 文件中读取数据。  

  - **输出内容**：与 `last` 类似，但专注于失败的尝试，包括尝试登录的用户名、终端、来源 IP/主机名和失败时间。  

  - **用法**：

    ```
    sudo lastb # 显示所有失败登录尝试（需要 root 权限）[61, 63]
    sudo lastb -n 5 # 显示最近 5 条失败登录尝试 [63]
    ```

  - **应用**：对于检测暴力破解攻击、可疑登录尝试或用户输入错误密码的频率非常有用。

- **`who` 命令**：

  - **作用**：显示当前登录到系统的用户列表。它从 `/var/run/utmp` 文件中读取数据。  

  - **输出内容**：包括用户名、登录终端、登录时间，以及远程登录的 IP 地址或主机名。  

  - **用法**：

    ```
    who # 显示当前登录用户
    who -a # 显示所有可用信息，包括系统启动时间、运行级别等 [65, 66]
    who -u # 显示用户空闲时间 [65, 66]
    ```

  - **应用**：快速了解当前系统上有哪些用户在线，以及他们的会话状态。

`last`、`lastb` 和 `who` 命令提供了用户活动的「快照」信息，分别展示了历史登录、失败尝试和当前会话。它们是进行初步安全监控和故障排除的基础工具，允许管理员快速识别可疑的登录模式或活跃的未经授权用户。这些命令依赖于特定的日志文件（`/var/log/wtmp`、`/var/log/btmp`、`/var/run/utmp`），这强调了日志完整性对于审计的重要性。通过分析这些日志，管理员可以及时发现异常行为，例如：频繁的失败登录尝试可能指示暴力破解，夜间来自不寻常 IP 的登录可能表明账户被盗用。

### `journalctl` 在用户审计中的应用

`journalctl` 是 `systemd` 日志系统（journal）的查询工具，它整合了来自内核、系统服务和应用程序的日志，提供了强大的过滤和查询功能，对于用户活动审计至关重要。  

- **显示所有日志**：

  ```
  journalctl
  ```

  默认显示所有日志，按时间倒序排列。  

- **按时间过滤**：

  ```
  journalctl --since "yesterday" # 显示从昨天开始的日志 [70]
  journalctl --since "2024-07-15 09:00:00" --until "2024-07-15 10:00:00" # 指定时间范围 [69]
  journalctl --since "1 hour ago" # 显示过去 1 小时的日志 [67]
  ```

- **按关键字过滤**：

  ```
  journalctl | grep "login" # 过滤包含"login"的日志 [70]
  journalctl -g "authentication failure" # 使用-g 选项直接过滤 [69]
  ```

- **按服务单元过滤**：可以过滤特定服务（如 SSHD）的日志，以审计 SSH 登录活动。  

  ```
  journalctl -u sshd # 显示 sshd 服务的日志
  journalctl -u systemd-logind --since "today" | grep session # 审计成功登录会话 [70]
  ```

- **审计用户登录事件**： `journalctl` 可以查询 Linux 审计子系统生成的结构化日志，提供更可靠的登录信息。  

  ```
  journalctl -q _AUDIT_TYPE=1112 _TRANSPORT=audit # 显示所有用户登录事件（成功和失败）[70]
  ```

  其中 `_AUDIT_TYPE=1112` 对应 `AUDIT_USER_LOGIN` 事件。  

- **实时跟踪日志**：

  ```
  journalctl -f # 实时显示新日志条目，类似于 tail -f [69]
  ```

`journalctl` 在 `systemd` 环境下对用户审计的优势在于其结构化日志和强大的过滤能力。它整合了来自不同源的日志，使得管理员能够更精确、更高效地调查用户活动，包括登录尝试、命令执行等。通过 `journalctl` 直接查询审计子系统，可以获得更可靠且防篡改的审计追踪。这种集中化和结构化的日志管理方式，极大地简化了日志分析和安全事件响应流程，是现代 Linux 系统审计不可或缺的工具。

### `auditd` 框架简介及其在监控用户行为中的作用

`auditd` 是 Linux 内核审计子系统（Linux Audit Framework）的用户空间守护进程，它能够提供对系统上各种事件的详细、可配置的审计跟踪。这包括文件访问、命令执行、系统调用等，是监控用户行为和满足安全合规性要求的强大工具。  

- **工作原理**： `auditd` 框架通过在内核级别捕获特定的系统调用和事件，并将其记录到 `/var/log/audit/audit.log` 文件中。  

  `auditctl` 命令用于定义和管理审计规则，这些规则指示内核应该记录哪些事件。  

- **监控用户行为的应用**： `auditd` 能够提供非常细粒度的用户行为监控，例如：

  - **文件访问和修改**：可以设置规则来监控对关键系统文件（如 `/etc/passwd`、`/etc/shadow`、`/etc/group`、`/etc/sudoers`）的读、写、执行或属性更改行为。  

    ```
    # 监控对/etc/passwd 文件的读、写和属性更改
    sudo auditctl -w /etc/passwd -p wra -k passwd_changes
    # -w：设置文件系统对象监视
    # -p：指定权限过滤器（w=写，r=读，a=属性更改）
    # -k：设置一个键值，用于在日志中标识此规则
    ```

  - **命令执行**：可以记录所有由特定用户或以特定权限执行的命令，包括其参数。  

    ```
    # 记录所有以 root 用户身份执行的命令
    sudo auditctl -a exit,always -F arch=b64 -F euid=0 -S execve -k root_commands
    # -a exit,always：在系统调用退出时总是生成审计记录
    # -F arch=b64：过滤 64 位系统架构
    # -F euid=0：过滤有效用户 ID 为 0（root）的事件
    # -S execve：监控 execve 系统调用（程序执行）
    ```

  - **特权提升工具的使用**：监控 `su`、`sudo` 等命令的执行，以检测潜在的权限提升尝试。  

    ```
    # 监控 sudo 命令的使用
    sudo auditctl -w /usr/bin/sudo -p x -k sudo_usage
    ```

  - **系统时间更改**：监控 `clock_settime` 等系统调用，以检测对系统时间的篡改。  

    ```
    # 监控系统时间更改
    sudo auditctl -a exit,always -F arch=b64 -S clock_settime -k time_change
    ```

  - **配置持久化**：为了使审计规则在系统重启后依然有效，需要将规则添加到 `/etc/audit/rules.d/audit.rules` 文件中，并重启 `auditd` 服务。  

- **最佳实践**：

  - **规则排序**：将最常发生的事件的规则放在审计规则列表的顶部，以优化性能。  

  - **排除噪音事件**：过滤掉不重要的或产生大量日志的事件，以避免日志泛滥，例如 SELinux AVC 记录、CWD 记录等。  

  - **合理设置缓冲区**：根据系统负载调整 `auditd` 的缓冲区大小，以避免在高峰期丢失审计事件。  

  - **监控关键目录**：对 Web 根目录 (`/var/www`) 等关键目录设置递归监控，以检测未经授权的访问或修改。  

`auditd` 框架是一个功能强大但配置复杂的工具，用于深入监控用户行为。它提供了内核级别的系统调用和文件访问日志，为安全取证和合规性提供了无与伦比的详细信息。然而，其复杂性要求管理员仔细配置规则（例如，平衡日志详细程度与系统性能），并遵循规则排序和过滤噪音事件等最佳实践，以防止日志泛滥。这对于检测复杂的攻击和确保系统问责制至关重要。通过 `auditd`，管理员可以构建一个全面的安全审计体系，及时发现和响应潜在的安全威胁。